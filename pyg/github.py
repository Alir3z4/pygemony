__author__ = 'Ian'

from github3 import login
from os import path

class GithubAPIManager:
    # repo_location = grappigpanda/pygemony.py
    def __init__(self, user, token, owner, repo):
        self.is_authed = False

        # Auth stuff
        self.user = user
        self.token = token
        self.gh = self.login()

        # Remote repo stuff
        self.owner = owner
        self.repo = repo
        self.curr_repo = self.gh.repository(owner, repo)

    def login(self):
        return login(self.user, self.token)

    def _save_submitted_todo(self, issue):
        print issue
        if not path.isfile('./.pyg-submitted'):
            with open('./.submitted', 'a+') as f:
                f.write(issue[3])
                f.write('\n')
            return True

        if issue[3] in open('./.pyg-submitted').read():
            return False
        else:
            with open('./.pyg-submitted', 'ab') as f:
                f.write(issue[3])
                f.write('\n')
            return True

    def commit(self, todo_found):
        # TODO(ian): Assign issues if () in line. (ian), for example
        for issue in todo_found:
            if self._save_submitted_todo(issue):
                self.curr_repo.create_issue(title=issue[2],
                                        body=self._construct_issue_body(issue))

    def _construct_issue_body(self, issue):
        str = 'File Location: {}<br>Line Number: {}'.format(issue[0], issue[1])
        str += '<br> This message was auto-generated by Pygemony:'
        str += '<a href="http://github.com/GrappigPanda/pygemony.py">Github</a>'
        return str

    def get_languages(self):
        for i in self.curr_repo.iter_languages():
            yield i
